const {
	bot, 
	token, 
	telegramAPI, 
	channelId, 
	sequalize
} = require('./core.js');

const keyboard = require('./keyboard');

const kb = require('./keyboard-buttons');

const axios = require('axios');

const fs = require('fs');

const path = require('path');

const download = require('download');

const {UserShema, PostShema, DownloadQueueShema, InfoShema, MemberPostShema} = require('./models');

const FormData = require('form-data');

const { query } = require('./db.js');
const { dirname } = require('path');

let onPosting, postingInterval, postingTimerID;


class User {

	isAdmin = false;
	firstName;
	userName;
	chatId;

	constructor(firstName,userName,chatId) {
		this.firstName = firstName;
		this.userName = userName;
		this.chatId = chatId;
	}

	getIsAdmin() {
		return this.isAdmin;
	}

	getFirstName() {
		return this.firstName;
	}

	getUserName() {
		return this.userName;
	}

	getChatId() {
		return this.chatId;
	}

}

class UserAdmin extends User {

	isAdmin = true;

	constructor(firstName,userName,chatId) {
		super(firstName,userName,chatId);
	}
	
}

//–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
async function connectToDB() {
	try {
		await sequalize.authenticate();
		await sequalize.sync()
		console.log('–ø–æ–¥–∫–ª—é–µ–Ω –∫ –±–¥');
	} catch (e) {
		console.log('–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–¥ –Ω–µ —É–¥–∞–ª–æ—Å—å')
	}
}

//—Å—Ç–∞—Ä—Ç–æ–≤—ã–π –¥–∏–∞–ª–æ–≥
async function start() {

	//–Ω–∞—á–∞–ª—å–Ω—ã–π –¥–∏–∞–ª–æ–≥ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞
	bot.onText(/\/start/, (msg) => {
		//–ø—Ä–æ–≤–µ—Ä–∫–∞ –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
		UserShema.findOne({
			where: {chatId: msg.chat.id}
		}).then( (user) => {

			if ( user instanceof UserShema ) {
					
				if ( user.isAdmin) {
					//–æ—Ç–ø—Ä–∞–≤–∫–∞ –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ –º–µ–Ω—é
					bot.sendMessage(user.chatId, `—Å–∞–ø, ${user.firstName}`, {
						reply_markup: {
							keyboard: keyboard.adminHome,
							resize_keyboard: true
						}
					});
				} else {

					if ( user.ban ) {
						bot.sendMessage(user.chatId, '–æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏–∫—á –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞');
					} else {
						//–æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
						bot.sendMessage(user.chatId, `\n—Å–∞–ø, ${user.firstName}\n–æ—Ç–ø—Ä–∞–≤—å –ø–∏–∫—á–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—á–µ—à—å –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å
						\n–µ—Å–ª–∏ —Ñ–æ—Ç–æ –ª–∏—á–Ω–æ–µ, —Ç–æ –Ω–∞–ø–∏—à–∏ –æ–± —ç—Ç–æ–º –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ —Ñ–æ—Ç–æ: —Ç–∞–∫–∏–µ —Ñ–æ—Ç–æ –Ω—É–∂–Ω–æ –ø–æ—Å—Ç–∏—Ç—å –ø–æ –æ–¥–Ω–æ–º—É
						\n—Ä–∞–Ω–¥–æ–º–ø–∏–∫ –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∞–ª—å–±–æ–º–∞–º–∏`, {
							reply_markup: {
								keyboard: keyboard.userHome,
								resize_keyboard: true
							}
						});
					}
				}
			} else {
				//–µ—Å–ª–∏ –Ω–µ —É–∑–Ω–∞–ª, —Ç–æ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
				createUser(msg);
			}

		} ).catch( (e) => {
			console.log(e);
		} )
	});

	//–∑–∞–ø—É—Å–∫ –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
	bot.onText(/[–∏–Ω—Ñ–æ|on/off –ø–æ—Å—Ç–∏–Ω–≥|–ø—Ä–µ–¥–ª–æ–∂–∫–∞|–∏–Ω—Ç–µ—Ä–≤–∞–ª|–ø—Ä–µ–¥–ª–æ–∂–∫–∞]/, adminActions);

	//–∑–∞–ø—É—Å–∫ –ø—Ä–æ—Å–ª—É—à–∫–∏ –ø–∏–∫—á –≤ –¥–∏–∞–ª–æ–≥–µ
	bot.on('photo', addDownloadQueue);

	//–∑–∞–ø—É—Å–∫ –ø—Ä–æ—Å–ª—É—à–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
	bot.onText(/[–∑–∞–≥—Ä—É–∑–∏—Ç—å|—É–¥–∞–ª–∏—Ç—å]/, savePostFromQueue); 

	//–∑–∞–ø–∏—Å—å –≤ –ª–æ–≥–∏ –±–æ—Ç–∞
	updateInfo(1000, false, 'prnaddictionBot').then( (data) => {
		onPosting = data.onPosting;
		postingInterval = data.postingInterval;
	} );

	//–∑–∞–ø—É—Å–∫ –ø—Ä–æ—Å–ª—É—à–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π —Å –ø–æ—Å—Ç–∞–º–∏ –≤ –ø—Ä–µ–¥–ª–æ–∂–∫–µ
	bot.on('callback_query', memberPostsActions);

};

//–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –ø–æ–¥ –ø–æ—Å—Ç–∞–º–∏ –≤ –ø—Ä–µ–¥–ª–æ–∂–∫–µ
function memberPostsActions(query) {

	switch ( query.data ) {
		case 'block': {

			let chatId = query.message.chat.id;

			MemberPostShema.findAll({
				where: {
					workInChatId: chatId
				}
			}).then( posts => {

				posts.forEach( post => {
					bot.deleteMessage(chatId, post.messageId);

					fs.unlink(path.join(__dirname, '/membersPosts/') + post.name + '.jpg', (e) => {
						console.log(e);
						post.destroy();
						post.save();
					});
					
				} );

				UserShema.findOne({
					where: {
						chatId: posts[0].userChatId
					}
				}).then( member => {
					member.ban = true;
					member.save().then( () => {
						bot.answerCallbackQuery(query.id, `${member.firstName} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω`);
					} )
				} )

			} )		
		} break;
		case 'deleteAll': {

			let chatId = query.message.chat.id;

			MemberPostShema.findAll({
				where: {
					workInChatId: chatId
				}
			}).then( posts => {

				posts.forEach( post => {
					bot.deleteMessage(chatId, post.messageId);

					fs.unlink(path.join(__dirname, '/membersPosts/') + post.name + '.jpg', (e) => {
						console.log(e);
						post.destroy();
						post.save();
					});
					
				} );
				bot.answerCallbackQuery(query.id, '–ø–æ—Å—Ç—ã —É–¥–∞–ª–µ–Ω—ã');
			} )	

		} break;
		case 'delete': {

			let chatId = query.message.chat.id;
			let messageId = query.message.message_id;

			MemberPostShema.findOne({
				where: {
					messageId: messageId
				}
			}).then( (post) => {

				bot.deleteMessage(chatId, messageId);
				post.destroy();
				post.save();

				bot.answerCallbackQuery(query.id, '–ø–æ—Å—Ç —É–¥–∞–ª–µ–Ω');
			} )

		} break;
		case 'publish': {
			
			let chatId = query.message.chat.id;
			let messageId = query.message.message_id;

			MemberPostShema.findOne({
				where: {
					messageId: messageId
				}
			}).then( (post) => {

				createPostInDB(post.name, post.userChatId, post.authorUserName, PostShema);
				fs.rename( path.join(__dirname + '/membersPosts/') + post.name + '.jpg', path.join(__dirname + '/posts/') + post.name + '.jpg', () => {
					bot.deleteMessage(chatId, post.messageId);
					bot.answerCallbackQuery(query.id, '–¥–æ–±–∞–≤–ª–µ–Ω –≤ –æ—á–µ—Ä–µ–¥—å –ø–æ—Å—Ç–∏–Ω–≥–∞');
					post.destroy();
					post.save();
				} )
			} )
		} break;
	}

}

//—Ñ—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥–∞ –≤ –∫–∞–Ω–∞–ª
async function autoPost() {

	console.log('Posting ON, postingInterval: ', postingInterval);

	//if (onPosting) {

		

		// PostShema.findOne({
		// 	order: [ [ 'ID' ]]
		// }).then( (data) => {

		// 	if ( data instanceof PostShema ) {
		// 		let formData = new FormData();
		// 		formData.append('chat_id', channelId);
		// 		formData.append('photo', fs.createReadStream(path.join(__dirname, '/posts/') + data.name + '.jpg'));
		// 		//formData.append('caption', namesOfPics[0]);
	
		// 		axios.post(`${telegramAPI}sendPhoto`, formData , {
		// 			headers: {
		// 				"Content-Type": "multipart/form-data; charset=UTF-8"
		// 			}
		// 		}).then( () => {
	
		// 			fs.unlink(path.join(__dirname, '/posts/') + data.name + '.jpg', (err => {
		// 				if (err) console.log(err);
		// 			}) );
	
		// 			data.destroy();
					
		// 		} )
		// 	} else {
		// 		onPosting = false;
		// 		updateInfo(postingInterval, false, 'prnaddictionBot');
		// 	}
	
		// } )

	//}
	
}

//—Ñ—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–∏–∫—á –≤ –æ—á–µ—Ä–µ–¥—å –∑–∞–≥—Ä—É–∑–∫–∏
async function addDownloadQueue(msg) {

	UserShema.findOne({
		where: {
			chatId: msg.chat.id
		}
	}).then( user => {

		if (  user.isAdmin ) {
			DownloadQueueShema.create({
				userChatId: user.chatId,
				name: msg.photo[ msg.photo.length - 1 ].file_id,
				isAdmin: true,
				messageId: msg.message_id
			});
		} else if ( !user.ban ) {
			DownloadQueueShema.create({
				userChatId: user.chatId,
				name: msg.photo[ msg.photo.length - 1 ].file_id,
				isAdmin: false,
				messageId: msg.message_id
			});
		}

	} )

}

//—Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∏–∫—á –∏–∑ –æ—á–µ—Ä–µ–¥–∏
function savePostFromQueue(msg) {

	let namesOfDownloadPic = [];

	DownloadQueueShema.findAll({
		where: {
			userChatId: msg.chat.id
		}
	}).then( posts => {

		if (msg.text == '–∑–∞–≥—Ä—É–∑–∏—Ç—å') {
	
			posts.forEach(element => {

				let postData = {
					name: element.name,
					isAdmin: element.isAdmin,
				};

				if ( element.isAdmin ) {
					if (downloadPhoto(element, '/posts')) {
						namesOfDownloadPic.push(postData);
						element.destroy();
					}
				} else {
					if (downloadPhoto(element, '/membersPosts')) {
						namesOfDownloadPic.push(postData);
						element.destroy();
					}
				}
			});
			
			if ( namesOfDownloadPic.length > 0 ) {
							
				namesOfDownloadPic.forEach( item => {

					if ( item.isAdmin ) {
						createPostInDB(item.name, msg.chat.id, msg.from.first_name, PostShema);
						
					} else {
						createPostInDB(item.name, msg.chat.id, msg.from.first_name, MemberPostShema);
					}
	
				} )

				bot.sendMessage(msg.chat.id, `üíæ ${namesOfDownloadPic.length}`).then( () => namesOfDownloadPic = []);
	
			} else {
				bot.sendMessage(msg.chat.id, '—á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫').then( () => namesOfDownloadPic = [] );
			};
	
		} else if ( msg.text == '—É–¥–∞–ª–∏—Ç—å' ) {

			posts.forEach(element => {

				bot.deleteMessage(msg.chat.id, element.messageId);
				element.destroy()
			});
	
			bot.sendMessage(msg.chat.id, '—Ö–æ—Ä–æ—à–æ, –≤—ã–±–µ—Ä–∏ —á—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–µ').then( () => namesOfDownloadPic = [] );
			
		}
	} )
}

//—Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function createUser(msg) {

	let chatId = msg.chat.id;
	let firstName = msg.from.first_name;
	let userName = msg.from.username;

	axios.post(`${telegramAPI}getChatMember`, {
		chat_id: channelId,
		user_id: chatId
	}).then( response => {

		switch ( response.data.result.status ) {
		
			case 'creator':
			case 'administrator': {
				// —Å–æ–∑–¥–∞—Ç—å —Å—É—â–Ω–æ—Å—Ç—å –∞–¥–º–∏–Ω–∞ –≤ –±–¥
				let userAdmin = new UserAdmin(firstName, userName, chatId);
	
				UserShema.create({
					chatId: userAdmin.getChatId(),
					isAdmin: userAdmin.getIsAdmin(),
					firstName: userAdmin.getFirstName(),
					userName: userAdmin.getUserName()
				}).then( (res) => {
					bot.sendMessage(res.chatId, `–ø—Ä–∏–≤–µ—Ç, ${res.firstName}\n–æ—Ç–ø—Ä–∞–≤—å –ø–∏–∫—á—É, –∞–ª—å–±–æ–º –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–ª—å–±–æ–º–æ–≤\n–ª–∏–±–æ –≤—ã–±–µ—Ä–∏ –ø—É–Ω–∫—Ç –º–µ–Ω—é`, {
						reply_markup: {
							keyboard: keyboard.adminHome,
							resize_keyboard: true
						}
					});
				} );
			} break;
			case 'member': {
				// —Å–æ–∑–¥–∞—Ç—å —Å—É—â–Ω–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å—á–∏–∫–∞ –≤ –±–¥
				let user = new User(firstName, userName, chatId);
				UserShema.create({
					chatId: user.getChatId(),
					isAdmin: user.getIsAdmin(),
					firstName: user.getFirstName(),
					userName: user.getUserName()
				}).then( (res) => {
					bot.sendMessage(res.chatId, `–ø—Ä–∏–≤–µ—Ç, ${res.firstName}`, {
						reply_markup: {
							keyboard: keyboard.userHome,
							resize_keyboard: true
						}
					});
				} );
			} break;
			default: 
				bot.sendMessage(chatId, '–ø–æ–¥–ø–∏—à–∏—Å—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏–º:\n@prnaddiction');
			break;
		};
	} );



};

//–º–µ–Ω—é –∞–¥–º–∏–Ω—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
async function adminActions(msg) {

	UserShema.findOne({
		where: {chatId: msg.chat.id}
	}).then( (userAdmin) => {

		let message = msg.text;
	
		if ( userAdmin instanceof UserShema && userAdmin.isAdmin ) {

			switch ( message ) {
				case kb.adminHome.info: {
					updateInfo(postingInterval, onPosting, userAdmin.userName).then( data => {
						bot.sendMessage(userAdmin.chatId, 
							`–ø–æ—Å—Ç–∏–Ω–≥: ${ data.onPosting ? '–∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è' : '–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}
							\n–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤ –≤ –∞—Ä—Ö–∏–≤–µ: ${data.countOfPost}
							\n–∏–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ—Å—Ç–∏–Ω–≥–∞: ${(data.postingInterval / 60000).toFixed(2)} –º–∏–Ω
							\n–ø—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ—Å—Ç–∏–Ω–≥–∞: ${data.estimatedPostingTime}`);
					} );
				} break;
				case kb.adminHome.startStopPosting: {			

					startStopPosting(userAdmin).then( data => {
						if (data instanceof InfoShema) {
							let autoPostingIs;

							data.onPosting ? autoPostingIs = '–∑–∞–ø—É—â–µ–Ω' : autoPostingIs = '–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
							
							bot.sendMessage(userAdmin.chatId, `–∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥ ${autoPostingIs}`);
						}
					})

				} break;
				case kb.adminHome.changeInterval: {
					changePostingInterval(userAdmin);
				} break;
				case kb.adminHome.adminMembersPics: {
					getPostsFromMembers(userAdmin);
				} break;
				case kb.adminBackMainMenu.mainMenu: {

					MemberPostShema.findAll({
						where: {
							workInChatId: userAdmin.chatId
						}
					}).then( posts => {
						
						posts.forEach( row => {

							bot.deleteMessage(userAdmin.chatId, row.messageId);
							row.messageId = null;
							row.workInChatId = null;
							row.save();

						} );
						
						bot.sendMessage(userAdmin.chatId, `–ø—Ä–µ–¥–ª–æ–∂–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞`, {
							reply_markup: {
								keyboard: keyboard.adminHome,
								resize_keyboard: true
							}
						})
					} )

				} break;
			}
		}

	} )
}

//–ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–∫–∏
function getPostsFromMembers(userAdmin) {

	bot.sendMessage(userAdmin.chatId, `
		\nüë§ –≤ –ø—Ä–µ–¥–ª–æ–∂–∫—É –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –ø–æ—Å—Ç—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –æ—á–µ—Ä–µ–¥–∏
		\nüåÅ –µ—Å–ª–∏ –æ–Ω–∏ –∫–æ–Ω—á–∏–ª–∏—Å—å - –ø–µ—Ä–µ–∑–∞–π–¥–∏ –≤ –ø—Ä–µ–¥–ª–æ–∂–∫—É
	`, {
		reply_markup: {
			keyboard: keyboard.adminBackMainMenu,
			resize_keyboard: true
		}
	});

	MemberPostShema.findOne({
		order: [ [ 'ID' ]],
		where: {
			workInChatId: null
		}
	}).then( (post) => {

		if ( post instanceof MemberPostShema ) {
			MemberPostShema.findAll({
				where: {
					userChatId: post.userChatId,
					workInChatId: null
				}
			}).then( (elements) => {
	
				UserShema.findOne({
					where: {
						chatId: post.userChatId
					}
				}).then( (memberInfo) => {
					elements.forEach( (memberPost) => {
	
						bot.sendPhoto(userAdmin.chatId, path.join(__dirname, `/membersPosts/${memberPost.name}.jpg`), {
							headers: {
								"Content-Type": "multipart/form-data"
							},
							reply_markup: {
								inline_keyboard: [
									[
										{
											text: '‚úÖ',
											callback_data: 'publish',
											row_width: 1
										},
										{
											text: 'üö´',
											callback_data: 'delete',
											row_width: 2
										},
									],
									[
										{
											text: 'B A N',
											callback_data: 'block',
		
										},
										{
											text: 'üóë all',
											callback_data: 'deleteAll'
										}
									]
								]
							},
							caption: `[üë§ ${memberInfo.firstName}](https://t.me/${memberInfo.userName})`,
							parse_mode: 'MarkdownV2'
		
						}).then( (msg) => {
							memberPost.messageId = msg.message_id;
							memberPost.workInChatId = userAdmin.chatId;
							memberPost.save();
						} )
		
					} )
				} )
	
			} )
		} else {
			bot.sendMessage(userAdmin.chatId, 'üì§ –ø—Ä–µ–¥–ª–æ–∂–∫–∞ –ø—É—Å—Ç–∞', {
				reply_markup: {
					keyboard: keyboard.adminHome,
					resize_keyboard: true
				}
			})
		}

	} )

}

//–∏–∑–º–µ–Ω—è–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ—Å—Ç–∏–Ω–≥–∞
function changePostingInterval(userAdmin) {

	bot.sendMessage(userAdmin.chatId, '–≤–≤–µ–¥–∏ –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ—Å—Ç–∏–Ω–≥–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö, –∂–¥—É').then( () => {
		bot.onText(/[1-9]/, (msg) => {
			bot.removeTextListener(/[1-9]/);

			if ( msg.text != 0 ) {

				let newInterval = msg.text * 60000;

				updateInfo(newInterval, onPosting, userAdmin.userName).then( (data) => {

					if ( data instanceof InfoShema) {

						postingInterval = data.postingInterval;

						if ( onPosting ) {
							clearInterval(postingTimerID);
							postingTimerID = setInterval(autoPost, postingInterval);
						}

						bot.sendMessage(userAdmin.chatId, `–∏–Ω—Ç–µ—Ä–≤–∞–ª –∏–∑–º–µ–Ω–µ–Ω: ${data.postingInterval / 60000} –º–∏–Ω
						\n–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @${data.userName}`);

					}

				} )
			}

		})
	} )

}

//—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–∏–∫—á–∏ –Ω–∞ –¥–∏—Å–∫
async function downloadPhoto(element, folder) {

	return (
		axios.post(`${telegramAPI}getFile`, {
			file_id: element.name
		}).then( (file) => {
	
			let filePath = file.data.result.file_path;
			let fileName = file.data.result.file_id;
	
			let downloadLink = `https://api.telegram.org/file/bot` + `${token}` + `/${filePath}`;
	
			return (
				download(downloadLink, path.join(__dirname, folder), {filename: `${fileName}.jpg`}).then( () => {

					return true;
				})
			)

		})
	)
	
}

//–¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å —Å –ø–æ—Å—Ç–æ–º –≤ –æ—á–µ—Ä–µ–¥—å –ø–æ—Å—Ç–∏–Ω–≥–∞ –ª–∏–±–æ –≤ –ø—Ä–µ–¥–ª–æ–∂–∫—É
async function createPostInDB(name, chatId, authorUserName, Shema) {

	await Shema.create({
		name: name,
		userChatId: chatId,
		authorUserName: authorUserName
	})
}

function startStopPosting(userAdmin) {

	onPosting ? onPosting = false : onPosting = true;

	if ( onPosting ) {
		postingTimerID = setInterval(autoPost, postingInterval);
	} else {
		clearInterval(postingTimerID);
	}

	return updateInfo(postingInterval, onPosting, userAdmin.userName)

};

//–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∏–Ω—Ñ—É –æ –±–æ—Ç–µ –≤ –ë–î –∏ –æ—Ç–¥–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
async function updateInfo(postingInterval, onPosting, userName) {

	let countOfPost = await PostShema.count();
	let estimatedPostingTime;

	//–ø—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ—Å—Ç–∏–Ω–≥–∞, —É—á–∏—Ç—ã–≤–∞—è –∫–æ–ª-–≤–æ –ø–æ—Å—Ç–æ–≤

	//–ø–æ–¥—Å—á–µ—Ç –≤ –º–∏–Ω—É—Ç–∞—Ö
	estimatedPostingTime = ((postingInterval * 60000) * countOfPost).toFixed(2);

	if ( estimatedPostingTime >= 60 ) {
		let hours = Math.trunc(estimatedPostingTime/60);
		let minutes = estimatedPostingTime % 60;

		estimatedPostingTime = `${hours} —á. ${minutes} –º.`;

	} else {
		estimatedPostingTime = estimatedPostingTime + ' –º–∏–Ω';
	}
	
	return (
		InfoShema.create({
			countOfPost: countOfPost,
			postingInterval: postingInterval,
			estimatedPostingTime: estimatedPostingTime,
			onPosting: onPosting,
			userName: userName
		})
	)
}

//–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î, –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ => —Å—Ç–∞—Ä—Ç –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
connectToDB().then( () =>  start());






	



